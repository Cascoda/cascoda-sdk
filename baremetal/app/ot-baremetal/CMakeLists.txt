# Global config ---------------------------------------------------------------
# cmake 3.11 is required in order to use the neat external project syntax
cmake_minimum_required (VERSION 3.11)
project (ca821x-openthread)

if (NOT CMAKE_HOST_UNIX)
	message(WARNING "Building Openthread on windows is a challenge. Contributions welcome but it's probably easier to switch to Linux.")
	message(WARNING "Skipping openthread build due to non-unix build system!")
	return()
endif()

# Set configuration variables -------------------------------------------------
set(CASCODA_OPENTHREAD_CONFIGURE_OPTS
       --enable-cli
       --enable-application-coap
       --enable-mac-filter
       --enable-dhcp6-client
       --enable-dhcp6-server
       --with-mac=external
       --enable-ftd
       --enable-mtd
       --disable-docs
     CACHE STRING
       "The arguments to be passed to configure when configuring openthread"
)

# Main library config ---------------------------------------------------------
add_library(ca821x-openthread-bm-plat
	${PROJECT_SOURCE_DIR}/platform/alarm.c
	${PROJECT_SOURCE_DIR}/platform/flash.c
	${PROJECT_SOURCE_DIR}/platform/logging.c
	${PROJECT_SOURCE_DIR}/platform/misc.c
	${PROJECT_SOURCE_DIR}/platform/radio.c
	${PROJECT_SOURCE_DIR}/platform/random.c
	${PROJECT_SOURCE_DIR}/platform/serial.c
	${PROJECT_SOURCE_DIR}/platform/settings.c
	)

# platform depends on header generated by openthread config stage
add_dependencies(ca821x-openthread-bm-plat openthread-build)

target_link_libraries(ca821x-openthread-bm-plat
	PUBLIC
		cascoda-bm-plat
	PRIVATE
		m
		openthread-plat-api
	)

target_compile_definitions(ca821x-openthread-bm-plat PRIVATE ${OPENTHREAD_CONFIG_DEFINE})

target_include_directories( ca821x-openthread-bm-plat
	PRIVATE
		${PROJECT_SOURCE_DIR}/platform
		${openthread_SOURCE_DIR}/src/core
		${openthread_BINARY_DIR}/include
	PUBLIC
		${openthread_SOURCE_DIR}/include
		${PROJECT_BINARY_DIR}/include
		${PROJECT_SOURCE_DIR}/include
	)

# Add helper interface libraries to simplify the cyclic dependancy between
# the platform layer and the openthread core.
add_library(ca821x-openthread-bm-ftd INTERFACE)
target_link_libraries(ca821x-openthread-bm-ftd
	INTERFACE
		openthread-ftd
		ca821x-openthread-bm-plat
		openthread-ftd
		ca821x-openthread-bm-plat
	)

add_library(ca821x-openthread-bm-mtd INTERFACE)
target_link_libraries(ca821x-openthread-bm-mtd
	INTERFACE
		openthread-mtd
		ca821x-openthread-bm-plat
		openthread-mtd
		ca821x-openthread-bm-plat
	)

# Test app config -------------------------------------------------------------
add_executable(utdapp
	${PROJECT_SOURCE_DIR}/source/utd_main.c
	${PROJECT_SOURCE_DIR}/source/utd_api.c
	)

target_include_directories(utdapp
	PRIVATE ${PROJECT_SOURCE_DIR}/platform
	)

target_link_libraries(utdapp ca821x-openthread-bm-mtd)

# convert to bin file format
cascoda_make_binary(utdapp)

# Run tests -------------------------------------------------------------------
include(CTest)
# TODO: Add tests
